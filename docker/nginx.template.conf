user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

# Load dynamic modules. See /usr/share/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

events {
  worker_connections 1024;
}

http {

  sendfile            on;
  tcp_nopush          on;
  tcp_nodelay         on;
  keepalive_timeout   65;
  types_hash_max_size 2048;

  server_tokens off;

  # include resolvers
  include /etc/nginx/resolvers.conf;

  include             /etc/nginx/mime.types;
  default_type        application/octet-stream;

  proxy_redirect          off;
  proxy_set_header        Host            $host;
  proxy_set_header        X-Real-IP       $remote_addr;
  proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;

  gzip on;
  gzip_disable msie6;
  gzip_static on;
  gzip_comp_level 4;
  gzip_proxied any;
  gzip_types text/plain
  text/css
  application/x-javascript
  application/javascript
  text/xml
  application/xml
  application/xml+rss
  text/javascript
  application/x-font-ttf
  application/x-font-otf
  application/font-woff
  application/font-woff2
  application/vnd.ms-fontobject
  ;

  log_format json_combined escape=json '{'
    '"@timestamp": "$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"remote_user":"$remote_user",'
    '"request_method":"$request_method",'
    '"request":"$request",'
    '"request_uri": "$request_uri",'
    '"server_protocol": "$server_protocol",'
    '"status": "$status",'
    '"body_bytes_sent":"$body_bytes_sent",'
    '"request_time":"$request_time",'
    '"http_referrer":"$http_referer",'
    '"http_user_agent":"$http_user_agent",'
    '"proxy_host": "$proxy_host",'
    '"correlationId": "$http_x_instana_t",'
    '"elastic_index": "hausrat",'
    '"X-Forwarded-For": "$http_Clientsource"'
    '}';

  # log errors to stderr
  error_log stderr info;

  server {
    listen 8080 default_server;
    server_name  _;
    root /www;

    # ssl configuration for upstream https connections
    #proxy_ssl_protocols           TLSv1 TLSv1.1 TLSv1.2;
    #proxy_ssl_ciphers             HIGH:!aNULL:!MD5;
    #proxy_ssl_trusted_certificate /etc/nginx/ssl/trusted_ca.crt;

    # pipe access log to stdout
    access_log /dev/stdout;
    rewrite_log on;

    set $bankverbindung $BANKVERBINDUNG_API;
    set $hausratapi $HAUSRAT_API;
    set $adressdaten $ADRESSDATEN_API;
    set $nationalitaeten $NATIONALITAETEN_API;
    set $so $SO_API;

    # Cross Origin Request Sharing
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';

    ############################################################################
    # DEFAULT LOCATIONS FOR STATIC CONTENT #####################################
    location / {
      # support angular ng-route virtual paths
      try_files $uri /$uri /index.html;

      # Security headers
      add_header 'X-XSS-Protection' '1; mode=block' always;
      add_header 'X-Content-Type-Options' 'nosniff' always;
      add_header 'Cache-Control' 'no-cache, no-store, must-revalidate;' always;
      add_header 'Pragma' 'no-cache' always;
      # Cross Origin Request Sharing - Muss hier nochmal rein, siehe https://www.peterbe.com/plog/be-very-careful-with-your-add_header-in-nginx
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
      add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
    }

    ## API MAPPINGS ############################################################

    location ^~ /api/bankverbindung/ {
        rewrite ^/api/bankverbindung/(.*) /$1 break;
        proxy_pass $bankverbindung;
    }

    location ^~ /api/adressen/ {
        rewrite ^/api/adressen/(.*) /$1 break;
        proxy_pass $adressdaten;
    }

    location ^~ /api/tarifierung/ {
        rewrite ^/api/tarifierung/(.*) /$1 break;
        proxy_pass $hausratapi;
    }

    location ^~ /api/nationalitaeten/ {
        rewrite ^/api/nationalitaeten/(.*) /$1 break;
        proxy_pass $nationalitaeten;
    }

    location ^~ /api/vorversicherer/ {
        rewrite ^/api/vorversicherer/(.*) /$1 break;
        proxy_pass $hausratapi;
    }

    location ^~ /api/tarifierungsergebnis/ {
        rewrite ^/api/tarifierungsergebnis/(.*) /$1 break;
        proxy_pass $hausratapi;
    }

    location /api/tarifierungspeichernladen/ {
        rewrite ^/api/tarifierungspeichernladen/(.*) /$1 break;
        proxy_pass $hausratapi;
    }

    location ^~ /api/police/ {
        rewrite ^/api/police/(.*) /$1 break;
        proxy_pass $hausratapi;
    }

    location ^~ /api/plzcheck/ {
        rewrite ^/api/plzcheck/(.*) /$1 break;
        proxy_pass $adressdaten;
    }

    location ^~ /api/maskenwechsel {
        rewrite ^/api/maskenwechsel /maskenwechsel break;
        proxy_pass $hausratapi;
    }

    location ^~ /api/bff {
        rewrite ^/api/bff/(.*) /$1 break;
        proxy_pass $hausratapi;
    }

    ############################################################################

  }
}

daemon off;
